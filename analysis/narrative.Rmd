---
title: "North Sea phytoplankton"
subtitle: "Narrative"
author: "Willem Stolte"
date: "17/06/2020"
output: html_document
---

```{css, echo = F}
.box {
  padding: 1em;
  background: white;
  color: blue;
  border: 2px solid orange;
  border-radius: 10px;
}
.center {
  text-align: center;
}
```


```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, fig.align="center")
require(sf)
require(tidyverse)
require(lubridate)
dataDir <- "../data/derived_data"
```

```{r styleDef, echo = T}
EMODnetMapCleanStyle <- theme_minimal() +
  theme(axis.text = element_blank(),
        axis.title = element_blank())

EMODnetMapNormalStyle <- 
  theme(axis.text = element_text(size = 12, color = "blue"),
        axis.title = element_text(size = 14, color = "blue"),
        legend.text = element_text(size = 10),
        legend.position = "right",
        legend.key.width = unit(10,"mm"),
        legend.key.height = unit(10, "mm"),
        plot.background = element_rect(fill = "grey90", colour = "white", size = 0),
        panel.border = element_blank()
)


```




:::: {.box data-latex=""}
::: {.center data-latex=""}
Objectives
:::

1. Extract phytoplankton observations for Greater North Sea from EMODnet Biology
1. Automize this extraction where possible
1. Visualize the data for inspection
1. Determine absence of phytoplankton species in the Greater North Sea
1. Produce a high quality data product containing both occurence and absence of phytoplanton in Greater North Sea
::::

# Introduction

## Documentation

Github project: https://github.com/wstolte/EMODnet-Biology-Phytoplankton-NorthSea

# Data extraction

## Temporal scale

Data from 1995 until now are considered for the current product.

## Geographical scale

The regions that were selected were assembled from the intersection of the IHO regions and the EEZ from the different countries. These subregions have ID's that can be used in the WFS query to the EMODnet Biology database.

```{r mapGreaterNorthSea, message=F, warning=F, comment=F, out.width="50%"}
regions <- sf::st_read(quiet = T, dsn = "../data/derived_data/simplified_greater_north_sea-selection_from_eez-iho_v4.geojson")
regions %>% ggplot() +
  geom_sf(fill = "blue", color = "white") +
  geom_sf_text(aes(label = mrgid), size = 2, color = "white") +
  theme(axis.title = element_blank(),
        axis.text = element_blank(),
        axis.ticks = element_blank())
```

## Strategy

For each of these subregions, data extraction was done in a two-step approach. 

1. Extract phytoplankton data by selecting only observations linkted to the trait "phytoplankton".
1. The unique datasets obtained in the first steps were inspected, and suitable datasets, which were expected to contain phytoplankton, were selected. The suitable datasets were then downloaded completely (without selection for traits)

The reason for these two steps is that not all phytoplankton have been given traits yet. Potentially, many species would not been selected in the first query




## Extraction of complete relevant datasets

Extracting all relevant datasets will result in more observations, but part of the observations may be of non-phytoplankton organisms. After cleaning this set from non-phytoplankton, it is expected that all phytoplankton observations remain, also those which at the moment do not have the trait attribute "phytoplankton".


```{r, message=F, warning=F}
# all2Data <- read_delim(file.path(dataDir, "all2Data.csv"), delim = ";")
load(file.path(dataDir, "all2Data.Rdata"))
```

This query resulted in `r length(all2Data$id)` observations

```{r, message=F, warning=F}
regionN <- all2Data %>%
  group_by(mrgid) %>% summarize(n = n()) %>% ungroup() %>%
  mutate(mrgid = as.numeric(mrgid))

regions %>% right_join(regionN, by = c(mrgid = "mrgid")) %>%
  mutate(n_km2 = n/area_km2) %>%
  ggplot() +
  geom_sf(aes(fill = n_km2)) +
  scale_fill_viridis_c()
```




## Join with trophic mode table

```{r}
trophy <- read_delim("p:/11200463-mixitin-mixotrophs/20.Data/project4_dataPaperTrophy/p7List_All.csv", delim = ";", guess_max = 10000)
Sys.sleep(10)
```



```{r, message=F, warning=F}
trophyData <- all2Data %>% 
  mutate(AphiaID = sub("http://marinespecies.org/aphia.php[?]p=taxdetails&id=", "", aphiaid, )) %>% 
  full_join(trophy, by = c(AphiaID = "AphiaID")) %>% 
  select(
    mrgid, datasetID, datecollected, decimallongitude, decimallatitude,
    scientificname, AphiaID, Trophy, typeMX
  ) %>%
  drop_na(Trophy) %>%
  mutate(
    season = case_when(
      month(datecollected) %in% c(6,7,8) ~ "summer", 
      month(datecollected) %in% c(3,4,5) ~ "spring", 
      month(datecollected) %in% c(9,10,11) ~ "autumn", 
      month(datecollected) %in% c(12, 1, 2) ~ "winter"
    )
  ) %>% drop_na(season) %>%
  mutate(season = factor(season, levels = c("winter", "spring", "summer", "autumn")))


```



```{r trophyMap, fig.width=10, fig.height=10, out.width="100%"}
plottrophy <- trophyData %>%
  group_by(decimallongitude, decimallatitude, Trophy, season) %>%
  summarize(n = n()) %>%
  filter(Trophy %in% c("mixotroph", "phototroph")) %>%
  spread(Trophy, n) %>%
  mutate(fMix = mixotroph/(mixotroph + phototroph)) %>%
  drop_na(fMix)

require(rworldxtra)
data(countriesHigh)
world <- st_as_sf(countriesHigh) %>% 
  filter(REGION == "Europe") %>%
  filter(ADMIN %in% c("Denmark", "Germany", "Netherlands", "Belgium", "United Kingdom", "France", "Norway", "Sweden")) %>%
  select(ADMIN)

ggplot() +
  stat_summary2d(data = plottrophy, aes(x = decimallongitude, y = decimallatitude, z=fMix), fun=mean, binwidth = c(0.5,0.5)) +
  geom_sf(data = world, fill = "grey", color = "white", alpha = 0.5) +
  scale_fill_viridis_c() +
  coord_sf(xlim = c(-15, 15), ylim = c(45, 65)) +
  facet_wrap(~ season) +
  EMODnetMapCleanStyle
```



